#language: fr
@exploitation @importFS @fcpLow @ci
Fonctionnalité: Import de FS - FCP LOW
  # En tant qu'exploitant,
  # je veux pouvoir importer des FS à partir d'un fichier CSV
  # afin que la création des FS soit facilitée

  @clearExploitBusinessLogs
  Scénario: Import de FS - Cas passant
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-success.csv"
    Et le nombre de lignes du fichier d'import de FS est 2
    Et je valide le formulaire d'import de FS
    Alors le message de confirmation d'import de FS est affiché
    Et le nombre de lignes du rapport d'import de FS est 2
    Et le nombre de FS créés lors de l'import est 2
    Et le nombre de FS en erreur lors de l'import est 0
    Et je navigue vers la page gestion des fournisseurs de service
    Et je cherche les fournisseurs de service avec "bdd-sp-"
    Et le fournisseur de service "bdd-sp-success-public" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-success-private" est affiché dans la liste
    Et je clique sur le bouton de modification du FS "bdd-sp-success-public"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-public"
    Et je vérifie la configuration du fournisseur de service
    Et je reviens en arrière
    Et je clique sur le bouton de modification du FS "bdd-sp-success-private"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-private"
    Et je vérifie la configuration du fournisseur de service
    Et 1 événement exploitation "import" "service-provider" est journalisé avec "name" "csmr-import-core publish"
    Et 2 événements exploitation "create" "service-provider" sont journalisés avec "name" "RegExp:^[0-9a-f]{64}$"

  @clearExploitBusinessLogs
  Scénario: Import de FS - Vérification du format
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-format.csv"
    Et le nombre de lignes du fichier d'import de FS est 25
    Et je valide le formulaire d'import de FS
    Alors le message de confirmation d'import de FS est affiché
    Et le nombre de lignes du rapport d'import de FS est 25
    Et le nombre de FS créés lors de l'import est 3
    Et le nombre de FS en erreur lors de l'import est 22
    Et je navigue vers la page gestion des fournisseurs de service
    Et je cherche les fournisseurs de service avec "bdd-sp-format-"
    Et le fournisseur de service "bdd-sp-format-adresses-ip-missing" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-format-adresses-ip-wrong" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-format-client-id-v1-missing" est affiché dans la liste
    Et 3 fournisseurs de service sont affichés dans la liste
    Et 1 événement exploitation "import" "service-provider" est journalisé avec "name" "csmr-import-core publish"
    Et 3 événements exploitation "create" "service-provider" sont journalisés avec "name" "RegExp:^[0-9a-f]{64}$"

  @clearExploitBusinessLogs
  Scénario: Import de FS - Vérification des doublons
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-duplicate.csv"
    Et le nombre de lignes du fichier d'import de FS est 7
    Et je valide le formulaire d'import de FS
    Alors le message de confirmation d'import de FS est affiché
    Et le nombre de lignes du rapport d'import de FS est 7
    Et le nombre de FS créés lors de l'import est 2
    Et le nombre de FS en erreur lors de l'import est 5
    Et je navigue vers la page gestion des fournisseurs de service
    Et je cherche les fournisseurs de service avec "bdd-sp-"
    Et le fournisseur de service "bdd-sp-created-existing-datapass-v1" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-created-existing-entity-id-v1" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-rejected-existing-datapass-v2" n'est pas affiché dans la liste
    Et le fournisseur de service "bdd-sp-rejected-existing-entity-id-v2" n'est pas affiché dans la liste
    Et le fournisseur de service "bdd-sp-duplicate-same-file-datapass-entity-id" n'est pas affiché dans la liste
    Et le fournisseur de service "bdd-sp-duplicate-same-file-datapass" n'est pas affiché dans la liste
    Et le fournisseur de service "bdd-sp-duplicate-same-file-entity-id" n'est pas affiché dans la liste
    Et 1 événement exploitation "import" "service-provider" est journalisé avec "name" "csmr-import-core publish"
    Et 2 événements exploitation "create" "service-provider" sont journalisés avec "name" "RegExp:^[0-9a-f]{64}$"

  @clearExploitBusinessLogs
  Scénario: Import de FS - Configuration des scopes additionnels correspondants
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-success-missing-scopes.csv"
    Et le nombre de lignes du fichier d'import de FS est 4
    Et je valide le formulaire d'import de FS
    Alors le message de confirmation d'import de FS est affiché
    Et le nombre de lignes du rapport d'import de FS est 4
    Et le nombre de FS créés lors de l'import est 4
    Et le nombre de FS en erreur lors de l'import est 0
    Et je navigue vers la page gestion des fournisseurs de service
    Et je cherche les fournisseurs de service avec "bdd-sp-"
    Et le fournisseur de service "bdd-sp-success-missing-openid" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-success-missing-profile" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-success-missing-identite_pivot" est affiché dans la liste
    Et le fournisseur de service "bdd-sp-success-missing-birth" est affiché dans la liste
    Et je clique sur le bouton de modification du FS "bdd-sp-success-missing-openid"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-missing-openid"
    Et je vérifie la configuration du fournisseur de service
    Et je reviens en arrière
    Et je clique sur le bouton de modification du FS "bdd-sp-success-missing-profile"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-missing-profile"
    Et je vérifie la configuration du fournisseur de service
    Et je reviens en arrière
    Et je clique sur le bouton de modification du FS "bdd-sp-success-missing-identite_pivot"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-missing-identite_pivot"
    Et je vérifie la configuration du fournisseur de service
    Et je reviens en arrière
    Et je clique sur le bouton de modification du FS "bdd-sp-success-missing-birth"
    Et j'utilise la configuration pour le fournisseur de service "bdd-sp-success-missing-birth"
    Et je vérifie la configuration du fournisseur de service
    Et 1 événement exploitation "import" "service-provider" est journalisé avec "name" "csmr-import-core publish"
    Et 4 événements exploitation "create" "service-provider" sont journalisés avec "name" "RegExp:^[0-9a-f]{64}$"

  Scénario: Import de FS - Erreur fichier vide
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-empty.csv"
    Alors le message d'erreur de sélection du fichier FS est affiché
      | message                                                        |
      | Le fichier CSV est vide ou ne contient pas de données valides. |

  Scénario: Import de FS - Erreur fichier invalide
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-invalid.csv"
    Et le nombre de lignes du fichier d'import de FS est 2
    Et je valide le formulaire d'import de FS
    Alors le message d'erreur d'import de FS est affiché
      | message                                                                                                                                                                                                         |
      | Le fichier CSV est mal formaté. Les colonnes : datapass_id, name, scopes, type, site, redirect_uris, post_logout_redirect_uris, signature_response_alg, email, phone, adresses_ip, client_id_v1 sont manquantes |

  Scénario: Import de FS - Erreur fichier colonnes manquantes
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-missing-columns.csv"
    Et le nombre de lignes du fichier d'import de FS est 1
    Et je valide le formulaire d'import de FS
    Alors le message d'erreur d'import de FS est affiché
      | message                                                                    |
      | Le fichier CSV est mal formaté. Les colonnes : type, email sont manquantes |

  Scénario: Import de FS - Erreur totp non valide renseigné
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-success.csv"
    Et le nombre de lignes du fichier d'import de FS est 2
    Et j'entre un totp invalide
    Et je clique sur le bouton "importer les FS en base"
    Alors le message d'erreur de totp est "Le TOTP saisi n'est pas valide"

  Scénario: Import de FS - Erreur totp non renseigné
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs de service
    Et que je clique sur le bouton d'import de FS
    Et que je suis redirigé vers la page d'import de fournisseurs de service
    Quand je sélectionne le fichier d'import de FS "import-sp-success.csv"
    Et le nombre de lignes du fichier d'import de FS est 2
    Et je clique sur le bouton "importer les FS en base"
    Alors le message d'erreur de totp est "Veuillez mettre un code TOTP valide."

  Scénario: Suppression des FS commençant par "bdd-sp-"
    Etant donné que je navigue sur la page login d'exploitation
    Et je me connecte à exploitation en tant que "exploitant"
    Et je navigue vers la page gestion des fournisseurs de service
    Quand je supprime les fournisseurs de service commençant par "bdd-sp-success"
    Et je supprime les fournisseurs de service commençant par "bdd-sp-"
