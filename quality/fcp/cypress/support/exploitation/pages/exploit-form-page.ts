import { ChainableElement } from '../../common/types';
import { OperatorUser } from '../helpers';

export default class ExploitFormPage {
  protected getAllFormInputs(): ChainableElement {
    return cy.get('input, textarea');
  }

  protected getActiveInputFromName(name: string): ChainableElement {
    return cy.get(`[name=${name}]:not([type="hidden"]):not([disabled])`);
  }

  protected getVisibleInputFromName(name: string): ChainableElement {
    return cy.get(`[name=${name}]:not([type="hidden"])`);
  }

  protected getValidationButton(): ChainableElement {
    return cy.get("[type='submit']");
  }

  protected getTotpMessageError(): ChainableElement {
    return cy.get('[data-testid="totp-message-error"]');
  }

  getTotpInput(): ChainableElement {
    return cy.get('#_totp');
  }

  fillValue(name: string, value: string | string[]): void {
    this.getActiveInputFromName(name).then(($elem) => {
      if ($elem.attr('type') === 'checkbox') {
        cy.wrap($elem).each(($el) => {
          if ($el.is(':checked')) {
            $el.prop('checked', false);
          }
        });
        cy.wrap($elem).check(value, { force: true });
      } else if ($elem.attr('type') === 'radio') {
        cy.wrap($elem).check(value, { force: true });
        cy.wrap($elem).filter(':checked').trigger('change', { force: true });
      } else if ($elem.is('select')) {
        cy.wrap($elem).select(value);
      } else {
        // If value is an array, join the content with \n characters
        const strValue = Array.isArray(value) ? value.join('\n') : value;
        cy.wrap($elem).clearThenType(strValue);
      }
    });
  }

  fillDefaultValues(values: Record<string, string | string[]>): void {
    const elementAlreadySet: string[] = [];
    this.getAllFormInputs().each(($el) => {
      const elementName = $el.attr('name');
      const value = values[elementName];
      // If the html element has not been set already and a value exists
      if (!elementAlreadySet.includes(elementName) && value) {
        this.fillValue(elementName, value);
        elementAlreadySet.push(elementName);
      }
    });
  }

  checkValues(values: Record<string, string | string[]>): void {
    Object.entries(values).forEach(([elementName, value]) => {
      this.getVisibleInputFromName(elementName)
        .first()
        .then(($el) => {
          if ($el.attr('type') === 'radio') {
            expect(value).to.be.a('string');
            this.checkHasRadioButtonValue(elementName, value as string);
          } else if ($el.attr('type') === 'checkbox') {
            expect(value).to.be.an('array');
            this.checkHasCheckboxValues(elementName, value as string[]);
          } else if ($el.is('select')) {
            expect(value).to.be.an('string');
            this.checkHasListSelectedOptionLabel(elementName, value as string);
          } else {
            const stringValue = Array.isArray(value) ? value.join('\n') : value;
            this.checkHasValue(elementName, stringValue);
          }
        });
    });
  }

  checkHasValue(name: string, value: string): void {
    this.getVisibleInputFromName(name).should('have.value', value);
  }

  checkHasRadioButtonValue(name: string, value: string): void {
    this.getVisibleInputFromName(name)
      .filter(':checked')
      .should('have.value', value);
  }

  checkHasCheckboxValues(name: string, values: string[]): void {
    const allCheckedValues: string[] = [];
    this.getVisibleInputFromName(name)
      .each(($el) => {
        if ($el.is(':checked')) {
          allCheckedValues.push($el.attr('value'));
        }
      })
      .then(() => {
        expect(allCheckedValues)
          .to.include.members(values)
          .to.have.length(values.length);
      });
  }

  checkAreCheckboxesDisabled(name: string, isDisabled: boolean): void {
    this.getVisibleInputFromName(name).each(($el) =>
      expect($el.is(':disabled')).to.eq(isDisabled),
    );
  }

  checkHasListSelectedOptionLabel(name: string, value: string): void {
    this.getVisibleInputFromName(name)
      .find(':selected')
      .should('contain', value);
  }

  fillValidTotp(user: OperatorUser): void {
    this.getTotpInput()
      .then(() => user.wrapTotp())
      .then((token: string) => this.getTotpInput().clearThenType(token));
  }

  fillInvalidTotp(): void {
    this.getTotpInput().clearThenType('******');
  }

  checkTotpErrorMessage(message: string): void {
    this.getTotpMessageError().should('contain.text', message);
  }

  validateForm(user: OperatorUser): void {
    this.fillValidTotp(user);
    this.getValidationButton().click();
  }
}
