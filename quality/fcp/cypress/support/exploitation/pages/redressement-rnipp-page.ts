import { User } from '../../common/helpers';
import { ChainableElement, UserClaims } from '../../common/types';
import { OperatorUser } from '../helpers';
import TotpModal from './totp-modal-component';

const RNIPP_PAGE_TITLE = 'Rechercher un usager';
const RNIPP_ERROR_MESSAGE =
  "Une erreur s'est produite lors de l'appel au RNIPP.";
const DEAD_FEMALE_USER_MESSAGE = "L'utilisatrice est déclarée décédée.";
const DEAD_MALE_USER_MESSAGE = "L'utilisateur est déclaré décédé.";
const DEAD_USER_MESSAGE_NEXT = " Aucune autre information n'est disponible.";

export default class RedressementRNIPPPage {
  getSupportIdInput(): ChainableElement {
    return cy.get('[name="supportId"]');
  }

  getGenderRadio(): ChainableElement {
    return cy.get('[name="gender"]');
  }

  getFamilyNameInput(): ChainableElement {
    return cy.get('[name="familyName"]');
  }

  getGivenNameInput(): ChainableElement {
    return cy.get('[name="givenName"]');
  }

  getBirthDateInput(): ChainableElement {
    return cy.get('[name="birthdate"]');
  }

  getIsFrenchRadio(): ChainableElement {
    return cy.get('[name="isFrench"]');
  }

  getCogInput(): ChainableElement {
    return cy.get('[name="birthLocation"]');
  }

  getSearchButton(): ChainableElement {
    return cy.get('#btn-research');
  }

  getRnippErrorMessage(): ChainableElement {
    return cy.get('#message.alert');
  }

  getDeadUserMessage(): ChainableElement {
    return cy.get('#dead');
  }

  getRnippLabelByAttribute(attribute: string): ChainableElement {
    return cy.xpath(
      `//div[@class='card-body']//div[div/text()="${attribute}"]/div[2]`,
    );
  }

  getRnippStatusLabel(): ChainableElement {
    return cy.xpath('//div[contains(text(),"Code retour RNIPP :")]/strong');
  }

  getAccountStatusLabel(): ChainableElement {
    return cy.get('#citizen-status-0 li:nth-of-type(1) span');
  }

  getAccountLastConnectionLabel(): ChainableElement {
    return cy.get('#citizen-status-0 li:nth-of-type(2)');
  }

  getAccountIdLabel(): ChainableElement {
    return cy.get('#citizen-status-0 li:nth-of-type(3)');
  }

  getDisableAccountButton(): ChainableElement {
    return cy.xpath('//button[@type="submit" and contains(.,"Désactiver")]');
  }

  getEnableAccountButton(): ChainableElement {
    return cy.xpath('//button[@type="submit" and contains(.,"Activer")]');
  }

  checkIsVisible(): void {
    cy.get('h3').contains(RNIPP_PAGE_TITLE);
  }

  fillInUserDetails(user: User): void {
    const supportId = '1000000000000000';
    this.getSupportIdInput().clear().type(supportId);
    this.getGenderRadio().check(user.claims['gender'], { force: true });
    // Handle RNIPP request without family name
    const familyName = user.claims['family_name'] || 'NoFamilyName';
    this.getFamilyNameInput()
      .clear()
      .type(familyName as string);
    this.getGivenNameInput()
      .clear()
      .type(user.claims['given_name'] as string);
    this.getBirthDateInput()
      .clear()
      .type(user.claims['birthdate'] as string);
    // If user is born in France
    if (user.claims['birthcountry'] === '99100') {
      this.getIsFrenchRadio().check('true', { force: true });
      this.getCogInput()
        .clear()
        .type(user.claims['birthplace'] as string);
    } else {
      this.getIsFrenchRadio().check('false', { force: true });
      this.getCogInput()
        .clear()
        .type(user.claims['birthcountry'] as string);
    }
  }

  checkRnippStatus(rnippStatus: string): void {
    this.getRnippStatusLabel().contains(rnippStatus);
  }

  checkIsRnippErrorDisplayed(displayed = true, rnippStatus = ''): void {
    if (!displayed) {
      this.getRnippErrorMessage().should('not.exist');
      return;
    }
    this.getRnippErrorMessage()
      .should('be.visible')
      .contains(RNIPP_ERROR_MESSAGE)
      .within(() => {
        if (rnippStatus) {
          this.checkRnippStatus(rnippStatus);
        } else {
          this.getRnippStatusLabel().should('not.exist');
        }
      });
  }

  checkIsDeadUser(isMale: boolean): void {
    this.getDeadUserMessage().should('be.visible');
    const message = isMale ? DEAD_MALE_USER_MESSAGE : DEAD_FEMALE_USER_MESSAGE;
    this.getDeadUserMessage().contains(`${message}${DEAD_USER_MESSAGE_NEXT}`);
  }

  checkSupportId(): void {
    // Check the support id returned by RNIPP matches the request
    this.getSupportIdInput()
      .invoke('attr', 'value')
      .then((supportId) => {
        this.getRnippLabelByAttribute('Numéro de ticket support').contains(
          supportId,
        );
      });
  }

  checkRnippUserDetails(userClaims: UserClaims): void {
    const rnippData = {
      birthcountry: {
        format: (text) => text,
        label: 'COG du pays de naissance',
      },
      birthdate: {
        format: (text) => text.replaceAll('-00', ''),
        label: 'Date de naissance',
      },
      birthplace: {
        format: (text) => text,
        label: 'COG du lieu de naissance',
      },
      family_name: {
        format: (text) => text.toUpperCase(),
        label: 'Nom',
      },
      gender: {
        format: (text) => (text === 'male' ? 'Masculin' : 'Féminin'),
        label: 'Genre',
      },
      given_name: {
        format: (text) => text,
        label: 'Prénoms',
      },
      // TODO: Experimental not used currently
      //      preferred_username: {
      //        format: (text) => text.toUpperCase(),
      //        label: "Nom d'usage",
      //      },
    };
    Object.entries(rnippData).forEach(([key, value]) => {
      const { format, label: labelName } = value;
      const label = this.getRnippLabelByAttribute(labelName);

      if (userClaims[key]) {
        label.invoke('text').should('contain', format(userClaims[key]));
      } else {
        label.invoke('text').should('match', /^\s*$/);
      }
    });
  }

  checkIsUnknownUser(): void {
    cy.get('#citizen-status-0').contains('Inconnu(e) de FranceConnect');
    this.getAccountStatusLabel().should('not.exist');
    this.getAccountLastConnectionLabel().should('not.exist');
    this.getAccountIdLabel().should('not.exist');
  }

  checkIsEnabledUser(enabled: boolean): void {
    const statusText = enabled ? 'Oui' : 'Non';
    this.getAccountStatusLabel().contains(statusText);
  }

  checkIsLastConnectionDisplayed(displayed: boolean): void {
    if (!displayed) {
      this.getAccountLastConnectionLabel().should('not.exist');
      return;
    }
    const regExp =
      /Dernière connexion : le (\d{2})\/(\d{2})\/(\d{4}) à (\d{2}:\d{2}:\d{2})/;
    this.getAccountLastConnectionLabel().invoke('text').should('match', regExp);
  }

  checkIsLastConnectionCorrect(): void {
    this.getAccountLastConnectionLabel()
      .invoke('text')
      .then((text) => {
        const regExp =
          /Dernière connexion : le (\d{2})\/(\d{2})\/(\d{4}) à (\d{2}:\d{2}:\d{2})/;
        const found = regExp.exec(text);
        expect(found, 'The last connection date is missing').to.exist;

        const [, dd, mm, yyyy, time] = found;
        const lastConnectionDate = new Date(`${yyyy}-${mm}-${dd}T${time}`);
        const nowDate = new Date();
        const delay = 30000; // 30s
        expect(
          lastConnectionDate.valueOf(),
          `The last connection date is in the future.`,
        ).to.be.below(nowDate.valueOf());
        expect(
          lastConnectionDate.valueOf(),
          `The last connection has not been refreshed since last time.`,
        ).to.be.above(nowDate.valueOf() - delay);
      });
  }

  checkIsAccountIdDisplayed(displayed: boolean): void {
    const accountIdRegExp =
      /AccountId : [0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;
    if (!displayed) {
      this.getAccountIdLabel().should('not.exist');
    } else {
      this.getAccountIdLabel().invoke('text').should('match', accountIdRegExp);
    }
  }

  disableUser(user: OperatorUser): void {
    this.getDisableAccountButton().click();
    const totpModal = new TotpModal();
    totpModal.submitTotp(user);
  }

  enableUser(user: OperatorUser): void {
    this.getEnableAccountButton().click();
    const totpModal = new TotpModal();
    totpModal.submitTotp(user);
  }
}
