import { Then, When } from '@badeball/cypress-cucumber-preprocessor';

import { getIdentityProviderNameByDescription } from '../../common/helpers';
import { IdentityProviderConfig } from '../../common/types';
import { OperatorUser } from '../helpers';
import ExploitIdpListPage from '../pages/exploit-idp-list-page';

const exploitIdpListPage = new ExploitIdpListPage();

When('je clique sur le bouton de création de FI', function () {
  exploitIdpListPage.getCreateIdpButton().click();
});

When(
  'je clique sur le bouton de modification du FI {string}',
  function (idpNameOrDescription: string) {
    // Try to retrieve the IDP from the fixtures otherwise use idpNameOrDescription as idpName
    const idpName =
      getIdentityProviderNameByDescription(
        this.identityProviders,
        idpNameOrDescription,
        false,
      ) ?? idpNameOrDescription;

    // Keep track of the idp id
    exploitIdpListPage
      .getIdpUid(idpName)
      .then((idpId) => (this.idpConfig.uid = idpId));

    exploitIdpListPage.navigateToUpdateIdpPage(idpName);
  },
);

When(
  /^je supprime le fournisseur d'identité "([^"]*)"$/,
  function (idpNameOrDescription: string) {
    // Try to retrieve the IDP from the fixtures otherwise use idpNameOrDescription as idpName
    const idpName =
      getIdentityProviderNameByDescription(
        this.identityProviders,
        idpNameOrDescription,
        false,
      ) ?? idpNameOrDescription;
    const user: OperatorUser = this.operatorUser;
    exploitIdpListPage.deleteIdp(idpName, user);
  },
);

When(
  /^je supprime les fournisseurs d'identité commençant par "([^"]*)"$/,
  function (idpNamePrefix: string) {
    const user: OperatorUser = this.operatorUser;
    exploitIdpListPage.deleteAllIdpStartingWith(idpNamePrefix, user);
  },
);

Then('le message de confirmation de création de FI est affiché', function () {
  // Retrieve the IDP name from the configuration used for the creation
  const { name: idpName }: IdentityProviderConfig = this.idpConfig;
  exploitIdpListPage.checkConfirmCreateMessage(idpName);
});

Then(
  'le message de confirmation de modification du FI {string} est affiché',
  function (idpNameOrDescription: string) {
    // Try to retrieve the IDP from the fixtures otherwise use idpNameOrDescription as idpName
    const idpName =
      getIdentityProviderNameByDescription(
        this.identityProviders,
        idpNameOrDescription,
        false,
      ) ?? idpNameOrDescription;
    exploitIdpListPage.checkConfirmUpdateMessage(idpName);
  },
);

Then(
  'le message de confirmation de suppression du FI {string} est affiché',
  function (idpNameOrDescription: string) {
    // Try to retrieve the IDP from the fixtures otherwise use idpNameOrDescription as idpName
    const idpName =
      getIdentityProviderNameByDescription(
        this.identityProviders,
        idpNameOrDescription,
        false,
      ) ?? idpNameOrDescription;
    exploitIdpListPage.checkConfirmDeleteMessage(idpName);
  },
);
